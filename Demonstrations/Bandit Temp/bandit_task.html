<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Armed Bandit Task</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .instructions p {
            margin-bottom: 10px;
        }

        #subject-form {
            margin-bottom: 30px;
        }

        #subject-form input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .task-area {
            display: none;
        }

        .trial-info {
            text-align: center;
            margin-bottom: 30px;
            font-size: 18px;
            color: #666;
        }

        .bandits {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin: 40px 0;
        }

        .bandit {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid #333;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .bandit.left {
            background: #3498db;
        }

        .bandit.right {
            background: #e74c3c;
        }

        .bandit:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .bandit.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .bandit.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .feedback {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            min-height: 60px;
            margin: 20px 0;
        }

        .feedback.win {
            color: #27ae60;
        }

        .feedback.lose {
            color: #c0392b;
        }

        .fixation {
            text-align: center;
            font-size: 72px;
            margin: 60px 0;
            color: #333;
        }

        .completion {
            display: none;
            text-align: center;
        }

        .completion h2 {
            color: #27ae60;
            margin-bottom: 20px;
        }

        .progress {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Two-Armed Bandit Task</h1>
        
        <div id="setup-area">
            <div class="instructions">
                <p><strong>Instructions:</strong></p>
                <p>You will see two colored circles on each trial. Your goal is to choose the circle that gives you a reward more often.</p>
                <p>Click on a circle to make your choice. You'll see whether you won or lost points.</p>
                <p>The better option may change during the task, so pay attention to your outcomes!</p>
                <p>There are 200 trials total. Try to earn as many points as possible.</p>
            </div>

            <form id="subject-form">
                <input type="text" id="subject-id" placeholder="Enter your participant ID" required>
                <button type="submit" class="btn">Start Task</button>
            </form>
        </div>

        <div class="task-area" id="task-area">
            <div class="progress">
                <div class="progress-bar" id="progress-bar">0 / 200</div>
            </div>
            
            <div class="trial-info" id="trial-info"></div>
            
            <div id="fixation" class="fixation" style="display: none;">+</div>
            
            <div id="choice-area" style="display: none;">
                <div class="bandits">
                    <div class="bandit left" id="bandit-left" onclick="makeChoice('left')">
                        <span>LEFT</span>
                    </div>
                    <div class="bandit right" id="bandit-right" onclick="makeChoice('right')">
                        <span>RIGHT</span>
                    </div>
                </div>
            </div>
            
            <div class="feedback" id="feedback"></div>
        </div>

        <div class="completion" id="completion">
            <h2>Task Complete! ðŸŽ‰</h2>
            <p>Thank you for participating!</p>
            <p id="final-score"></p>
            <p style="margin-top: 20px; color: #666;">Your data has been saved.</p>
        </div>
    </div>

    <script>
        // Configuration
        const TOTAL_TRIALS = 10;
        const FIXATION_DURATION = 500; // ms
        const FEEDBACK_DURATION = 1000; // ms
        const ITI_DURATION = 500; // ms
        
        // Google Apps Script Web App URL - YOU NEED TO REPLACE THIS
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbwrbFKW5TQcTi5iLA_c2ertdIc10yeh2T0vnZWg76Vrl32q6jjUoCtY6VJ158WJWNlq/exec';

        // Task state
        let subjectID = '';
        let currentTrial = 0;
        let totalScore = 0;
        let trialData = [];
        let probabilities = { left: 0.5, right: 0.5 };
        let blockSchedule = [];
        let trialStartTime = 0;

        // Generate block schedule
        function generateBlockSchedule() {
            const schedule = [];
            let trialsAssigned = 0;
            
            while (trialsAssigned < TOTAL_TRIALS) {
                // Random block length between 30-45 trials
                const blockLength = Math.floor(Math.random() * 16) + 30;
                const trialsInBlock = Math.min(blockLength, TOTAL_TRIALS - trialsAssigned);
                
                // Randomly assign probabilities (0.9/0.1, 0.1/0.9, or 0.5/0.5)
                const configs = [
                    { left: 0.9, right: 0.1 },
                    { left: 0.1, right: 0.9 },
                    { left: 0.5, right: 0.5 }
                ];
                const config = configs[Math.floor(Math.random() * configs.length)];
                
                for (let i = 0; i < trialsInBlock; i++) {
                    schedule.push(config);
                }
                
                trialsAssigned += trialsInBlock;
            }
            
            return schedule;
        }

        // Start task
        document.getElementById('subject-form').addEventListener('submit', function(e) {
            e.preventDefault();
            subjectID = document.getElementById('subject-id').value.trim();
            
            if (subjectID) {
                blockSchedule = generateBlockSchedule();
                document.getElementById('setup-area').style.display = 'none';
                document.getElementById('task-area').style.display = 'block';
                startTrial();
            }
        });

        function startTrial() {
            if (currentTrial >= TOTAL_TRIALS) {
                endTask();
                return;
            }

            // Update progress
            updateProgress();

            // Set probabilities for this trial
            probabilities = blockSchedule[currentTrial];

            // Show fixation
            document.getElementById('choice-area').style.display = 'none';
            document.getElementById('feedback').textContent = '';
            document.getElementById('fixation').style.display = 'block';

            setTimeout(() => {
                document.getElementById('fixation').style.display = 'none';
                showChoice();
            }, FIXATION_DURATION);
        }

        function showChoice() {
            document.getElementById('choice-area').style.display = 'block';
            document.getElementById('bandit-left').classList.remove('disabled');
            document.getElementById('bandit-right').classList.remove('disabled');
            trialStartTime = Date.now();
        }

        function makeChoice(side) {
            // Disable further clicks
            document.getElementById('bandit-left').classList.add('disabled');
            document.getElementById('bandit-right').classList.add('disabled');

            const reactionTime = Date.now() - trialStartTime;
            
            // Determine outcome
            const probability = probabilities[side];
            const outcome = Math.random() < probability ? 1 : 0;
            
            if (outcome === 1) {
                totalScore++;
            }

            // Show feedback
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.textContent = outcome === 1 ? '+1 Point!' : '+0 Points';
            feedbackEl.className = 'feedback ' + (outcome === 1 ? 'win' : 'lose');

            // Save trial data
            const trial = {
                subjectID: subjectID,
                trial: currentTrial + 1,
                choice: side,
                outcome: outcome,
                reactionTime: reactionTime,
                leftProb: probabilities.left,
                rightProb: probabilities.right,
                timestamp: new Date().toISOString()
            };
            
            trialData.push(trial);

            // Send to Google Sheets (async, don't wait)
            sendToGoogleSheets(trial);

            currentTrial++;

            // Next trial after feedback + ITI
            setTimeout(() => {
                startTrial();
            }, FEEDBACK_DURATION + ITI_DURATION);
        }

        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const percentage = (currentTrial / TOTAL_TRIALS) * 100;
            progressBar.style.width = percentage + '%';
            progressBar.textContent = `${currentTrial} / ${TOTAL_TRIALS}`;
        }

        function endTask() {
            document.getElementById('task-area').style.display = 'none';
            document.getElementById('completion').style.display = 'block';
            document.getElementById('final-score').textContent = 
                `You earned ${totalScore} out of ${TOTAL_TRIALS} possible points!`;
        }

        async function sendToGoogleSheets(trial) {
            try {
                await fetch(SHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(trial)
                });
            } catch (error) {
                console.error('Error sending data to Google Sheets:', error);
                // Store locally as backup
                localStorage.setItem('bandit_backup_' + Date.now(), JSON.stringify(trial));
            }
        }
    </script>
</body>
</html>
