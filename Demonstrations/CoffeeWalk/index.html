<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Coffee Walk | TD Learning State Values</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Lora:ital,wght@0,400;0,700;1,400&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            line-height: 1.7;
            color: #1e293b;
        }

        .serif { font-family: 'Lora', serif; }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: currentColor;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .slider-amber { background: #fef3c7; color: #d97706; }
        .slider-violet { background: #ede9fe; color: #7c3aed; }
        .slider-rose { background: #ffe4e6; color: #e11d48; }
        .slider-emerald { background: #d1fae5; color: #059669; }

        .param-input {
            width: 70px;
            padding: 2px 6px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: right;
            background: white;
        }

        .param-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        @keyframes walkBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        @keyframes celebrateCoffee {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-10deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            75% { transform: scale(1.2) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .walking {
            animation: walkBounce 0.3s ease-in-out;
        }

        .celebrate {
            animation: celebrateCoffee 0.6s ease-in-out;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(217, 119, 6, 0); }
        }

        .pulse-glow {
            animation: pulseGlow 1.5s ease-in-out infinite;
        }

        .location-card {
            transition: all 0.3s ease;
        }

        .location-card.active {
            transform: scale(1.05);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .value-indicator {
            transition: all 0.5s ease;
        }

        .td-flash {
            animation: tdFlash 0.5s ease-out;
        }

        @keyframes tdFlash {
            0% { background-color: rgba(16, 185, 129, 0.5); }
            100% { background-color: transparent; }
        }

        .td-flash-negative {
            animation: tdFlashNeg 0.5s ease-out;
        }

        @keyframes tdFlashNeg {
            0% { background-color: rgba(239, 68, 68, 0.5); }
            100% { background-color: transparent; }
        }

        .prose h2 {
            font-weight: 700;
            font-size: 1.875rem;
            margin-top: 2.5rem;
            margin-bottom: 1.25rem;
            color: #0f172a;
        }

        .prose p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        .agent-emoji {
            font-size: 2.5rem;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .path-segment {
            height: 4px;
            background: linear-gradient(90deg, #e2e8f0 0%, #e2e8f0 50%, transparent 50%);
            background-size: 12px 4px;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto space-y-8">

        <!-- Header -->
        <header class="bg-white border-b border-slate-200 pt-12 pb-10 -mx-4 md:-mx-8 -mt-4 md:-mt-8 px-4 md:px-8 mb-4">
            <div class="max-w-4xl mx-auto text-center">
                <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 mb-4 leading-tight">
                    The Coffee Walk:
                    <br/><span class="text-amber-600">Learning State Values</span>
                </h1>
                <p class="text-lg text-slate-500 serif italic max-w-2xl mx-auto">
                    Watch an agent learn that being close to coffee is valuable. Values propagate backward from the goal, teaching each state how "good" it is to be there.
                </p>
            </div>
        </header>

        <!-- Simulator -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Controls Panel -->
            <div class="lg:col-span-1 space-y-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-fit">
                <div class="flex items-center gap-2 text-lg font-semibold border-b pb-2 mb-4">
                    <svg class="w-5 h-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Parameters
                </div>

                <div class="space-y-5">
                    <!-- Learning Rate -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-600">Learning Rate \(\alpha\)</label>
                            <input type="number" id="alpha-val" class="param-input text-violet-600" value="0.3" min="0.01" max="1.0" step="0.01">
                        </div>
                        <input type="range" id="alpha" min="0.01" max="1.0" step="0.01" value="0.3" class="w-full slider-violet">
                        <p class="text-[10px] text-slate-400 mt-1 italic">How quickly values are updated</p>
                    </div>

                    <!-- Discount Factor -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-600">Discount Factor \(\gamma\)</label>
                            <input type="number" id="gamma-val" class="param-input text-amber-600" value="0.9" min="0" max="1.0" step="0.05">
                        </div>
                        <input type="range" id="gamma" min="0" max="1.0" step="0.05" value="0.9" class="w-full slider-amber">
                        <p class="text-[10px] text-slate-400 mt-1 italic">How much future rewards decay with distance</p>
                    </div>

                    <!-- Coffee Reward -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-600">Coffee Reward \(R\)</label>
                            <input type="number" id="reward-val" class="param-input text-emerald-600" value="10" min="1" max="20" step="1">
                        </div>
                        <input type="range" id="reward" min="1" max="20" step="1" value="10" class="w-full slider-emerald">
                        <p class="text-[10px] text-slate-400 mt-1 italic">How rewarding is getting coffee</p>
                    </div>

                    <!-- Closed Probability -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-600">Shop Closed Probability</label>
                            <input type="number" id="closed-val" class="param-input text-rose-600" value="0" min="0" max="0.5" step="0.05">
                        </div>
                        <input type="range" id="closed" min="0" max="0.5" step="0.05" value="0" class="w-full slider-rose">
                        <p class="text-[10px] text-slate-400 mt-1 italic">Chance the shop is closed (no reward)</p>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="pt-4 border-t space-y-3">
                    <button id="walk-btn" class="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-xl bg-amber-500 text-white font-semibold hover:bg-amber-600 transition-colors shadow-lg shadow-amber-200 pulse-glow">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="5" r="2"/>
                            <path d="M10 22v-5l-1-1v-4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v4l-1 1v5"/>
                        </svg>
                        Walk to Coffee
                    </button>
                    <div class="flex gap-2">
                        <button id="walk-10-btn" class="flex-1 flex items-center justify-center gap-1 px-4 py-2 rounded-lg border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors text-sm">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 19 22 12 13 5 13 19"/>
                                <polygon points="2 19 11 12 2 5 2 19"/>
                            </svg>
                            Walk √ó10
                        </button>
                        <button id="reset-btn" class="flex-1 flex items-center justify-center gap-1 px-4 py-2 rounded-lg border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-colors text-sm">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1 4 1 10 7 10"/>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                            </svg>
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Episode Counter -->
                <div class="bg-slate-50 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-slate-800" id="episode-count">0</div>
                    <div class="text-xs text-slate-500 uppercase tracking-wide">Walks</div>
                </div>
            </div>

            <!-- Main Visualization -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Path Visualization -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 text-amber-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        The Journey
                    </h3>
                    
                    <!-- Path -->
                    <div class="relative">
                        <!-- Agent -->
                        <div id="agent-container" class="absolute -top-8 transition-all duration-300 ease-in-out z-10" style="left: 0%;">
                            <span class="agent-emoji" id="agent">üö∂</span>
                        </div>

                        <!-- Locations -->
                        <div class="grid grid-cols-4 gap-2 relative">
                            <!-- Home -->
                            <div class="location-card bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border-2 border-blue-200 text-center" id="loc-0">
                                <div class="text-4xl mb-2">üè†</div>
                                <div class="text-sm font-semibold text-slate-700">Home</div>
                                <div class="text-xs text-slate-500">State 0</div>
                                <div class="mt-3 bg-white rounded-lg p-2 shadow-inner">
                                    <div class="text-xs text-slate-500">Value</div>
                                    <div class="text-lg font-bold text-blue-600" id="val-0">0.00</div>
                                </div>
                            </div>

                            <!-- Park -->
                            <div class="location-card bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border-2 border-green-200 text-center" id="loc-1">
                                <div class="text-4xl mb-2">üå≥</div>
                                <div class="text-sm font-semibold text-slate-700">Park</div>
                                <div class="text-xs text-slate-500">State 1</div>
                                <div class="mt-3 bg-white rounded-lg p-2 shadow-inner">
                                    <div class="text-xs text-slate-500">Value</div>
                                    <div class="text-lg font-bold text-green-600" id="val-1">0.00</div>
                                </div>
                            </div>

                            <!-- Street -->
                            <div class="location-card bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl p-4 border-2 border-slate-200 text-center" id="loc-2">
                                <div class="text-4xl mb-2">üöó</div>
                                <div class="text-sm font-semibold text-slate-700">Street</div>
                                <div class="text-xs text-slate-500">State 2</div>
                                <div class="mt-3 bg-white rounded-lg p-2 shadow-inner">
                                    <div class="text-xs text-slate-500">Value</div>
                                    <div class="text-lg font-bold text-slate-600" id="val-2">0.00</div>
                                </div>
                            </div>

                            <!-- Coffee Shop -->
                            <div class="location-card bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4 border-2 border-amber-300 text-center" id="loc-3">
                                <div class="text-4xl mb-2" id="coffee-icon">‚òï</div>
                                <div class="text-sm font-semibold text-slate-700">Coffee Shop</div>
                                <div class="text-xs text-slate-500">Goal!</div>
                                <div class="mt-3 bg-white rounded-lg p-2 shadow-inner">
                                    <div class="text-xs text-slate-500">Reward</div>
                                    <div class="text-lg font-bold text-amber-600" id="reward-display">+10</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Value Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-violet-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 20V10M18 20V4M6 20v-4"/>
                        </svg>
                        Learned State Values \(V(s)\)
                    </h3>
                    <div class="flex justify-around items-end h-40 border-b border-slate-200 pb-2 mb-4">
                        <div class="flex flex-col items-center w-1/4">
                            <div class="w-full max-w-[60px] bg-blue-200 rounded-t value-indicator transition-all" id="bar-0" style="height: 0%"></div>
                            <span class="text-xs font-medium text-slate-600 mt-2">üè† Home</span>
                        </div>
                        <div class="flex flex-col items-center w-1/4">
                            <div class="w-full max-w-[60px] bg-green-200 rounded-t value-indicator transition-all" id="bar-1" style="height: 0%"></div>
                            <span class="text-xs font-medium text-slate-600 mt-2">üå≥ Park</span>
                        </div>
                        <div class="flex flex-col items-center w-1/4">
                            <div class="w-full max-w-[60px] bg-slate-200 rounded-t value-indicator transition-all" id="bar-2" style="height: 0%"></div>
                            <span class="text-xs font-medium text-slate-600 mt-2">üöó Street</span>
                        </div>
                        <div class="flex flex-col items-center w-1/4">
                            <div class="w-full max-w-[60px] bg-amber-200 rounded-t value-indicator transition-all" id="bar-3" style="height: 0%"></div>
                            <span class="text-xs font-medium text-slate-600 mt-2">‚òï Goal</span>
                        </div>
                    </div>

                    <!-- Theoretical Values -->
                    <div class="bg-violet-50 rounded-lg p-3 text-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-violet-600 font-semibold">Theoretical Values</span>
                            <span class="text-violet-400">(after convergence)</span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-center text-xs">
                            <div>
                                <span class="font-mono text-violet-700" id="theory-0">‚Äî</span>
                            </div>
                            <div>
                                <span class="font-mono text-violet-700" id="theory-1">‚Äî</span>
                            </div>
                            <div>
                                <span class="font-mono text-violet-700" id="theory-2">‚Äî</span>
                            </div>
                            <div>
                                <span class="font-mono text-violet-700" id="theory-3">‚Äî</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TD Error Log -->
                <div class="bg-gradient-to-r from-slate-50 to-amber-50 p-4 rounded-xl border border-slate-100">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-semibold text-slate-700">Last Walk Summary</span>
                        <span class="text-xs text-slate-500" id="walk-status">Ready to walk!</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div class="text-xs text-slate-500 mb-1">Steps Taken</div>
                            <div class="text-xl font-bold text-slate-700" id="steps-taken">‚Äî</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div class="text-xs text-slate-500 mb-1">Reward Received</div>
                            <div class="text-xl font-bold text-emerald-600" id="reward-received">‚Äî</div>
                        </div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <div class="text-xs text-slate-500 mb-1">Avg TD Error</div>
                            <div class="text-xl font-bold" id="avg-td-error"><span class="text-slate-300">‚Äî</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Explanation Section -->
        <div class="prose max-w-4xl mx-auto bg-white p-8 md:p-12 rounded-2xl shadow-sm border border-slate-100 mt-12">
            <h2 class="flex items-center gap-3">
                <svg class="w-8 h-8 text-amber-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3M12 17h.01"/>
                </svg>
                Understanding State Values
            </h2>

            <p>
                Every morning, you walk from Home ‚Üí Park ‚Üí Street ‚Üí Coffee Shop. At the end, you get your delicious coffee reward. 
                Over time, your brain learns that even being at the <em>Park</em> is valuable‚Äîbecause it means coffee is coming soon!
            </p>

            <h3 class="text-xl font-semibold mt-8 mb-4">The Bellman Equation</h3>
            <p>
                The value of a state is the expected total reward you'll receive from that state onward. 
                For a deterministic path like ours, the theoretical value of each state follows:
            </p>

            <div class="bg-slate-50 p-6 rounded-xl my-6 text-center">
                <div class="text-lg">
                    \[V(s) = R(s) + \gamma \cdot V(s')\]
                </div>
                <div class="text-sm text-slate-500 mt-3">
                    Value of state = Immediate reward + Discounted value of next state
                </div>
            </div>

            <p>
                Working backwards from the Coffee Shop:
            </p>

            <ul class="space-y-2 my-4">
                <li><strong>Coffee Shop:</strong> \(V = R\) (you get the reward!)</li>
                <li><strong>Street:</strong> \(V = \gamma \cdot R\) (one step away)</li>
                <li><strong>Park:</strong> \(V = \gamma^2 \cdot R\) (two steps away)</li>
                <li><strong>Home:</strong> \(V = \gamma^3 \cdot R\) (three steps away)</li>
            </ul>

            <h3 class="text-xl font-semibold mt-8 mb-4">The Discount Factor \(\gamma\)</h3>
            <p>
                The discount factor controls how much you value <em>future</em> rewards compared to <em>immediate</em> ones:
            </p>

            <ul class="space-y-2 my-4">
                <li><strong>\(\gamma = 1.0\):</strong> Future rewards are just as good as immediate ones. All states have value ‚âà R.</li>
                <li><strong>\(\gamma = 0.9\):</strong> Each step of distance costs 10% of value. States closer to coffee are worth more.</li>
                <li><strong>\(\gamma = 0.5\):</strong> Steep discounting! Only states very close to the goal have significant value.</li>
                <li><strong>\(\gamma = 0\):</strong> Only immediate rewards matter. States before the goal have value 0.</li>
            </ul>

            <div class="bg-amber-50 border border-amber-200 rounded-xl p-6 my-6">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">‚òï</span>
                    <div>
                        <strong class="text-amber-800">Try it!</strong>
                        <p class="text-amber-700 text-sm mt-1 mb-0">
                            Start with \(\gamma = 0.9\) and run 20 walks. Watch values propagate backward from the Coffee Shop. 
                            Then try \(\gamma = 0.5\) vs \(\gamma = 1.0\) to see how discounting affects the value gradient!
                        </p>
                    </div>
                </div>
            </div>

            <h3 class="text-xl font-semibold mt-8 mb-4">What If the Shop Is Closed?</h3>
            <p>
                Set the "Shop Closed Probability" above 0 to introduce uncertainty. Sometimes you'll walk all the way there 
                and get nothing! This creates negative prediction errors (disappointment) and lowers the learned values.
            </p>
        </div>

        <!-- Footer -->
        <footer class="text-center py-8 text-sm text-slate-400">
            <p>The Coffee Walk - A TD Learning Demonstration</p>
            <p class="mt-1">Inspired by Sutton & Barto's Reinforcement Learning: An Introduction</p>
        </footer>
    </div>

    <script>
        // State
        let values = [0, 0, 0, 0]; // Home, Park, Street, Coffee
        let episodeCount = 0;
        let currentPosition = 0;
        let isAnimating = false;

        // DOM Elements
        const alphaSlider = document.getElementById('alpha');
        const alphaVal = document.getElementById('alpha-val');
        const gammaSlider = document.getElementById('gamma');
        const gammaVal = document.getElementById('gamma-val');
        const rewardSlider = document.getElementById('reward');
        const rewardVal = document.getElementById('reward-val');
        const closedSlider = document.getElementById('closed');
        const closedVal = document.getElementById('closed-val');
        const walkBtn = document.getElementById('walk-btn');
        const walk10Btn = document.getElementById('walk-10-btn');
        const resetBtn = document.getElementById('reset-btn');
        const episodeCountDisplay = document.getElementById('episode-count');
        const agentContainer = document.getElementById('agent-container');
        const agent = document.getElementById('agent');

        // Sync sliders with inputs
        function syncSliderInput(slider, input) {
            slider.addEventListener('input', () => {
                input.value = slider.value;
                if (slider === rewardSlider) updateRewardDisplay();
                updateTheoreticalValues();
            });
            input.addEventListener('change', () => {
                let val = parseFloat(input.value);
                val = Math.max(parseFloat(slider.min), Math.min(parseFloat(slider.max), val));
                input.value = val;
                slider.value = val;
                if (slider === rewardSlider) updateRewardDisplay();
                updateTheoreticalValues();
            });
        }

        syncSliderInput(alphaSlider, alphaVal);
        syncSliderInput(gammaSlider, gammaVal);
        syncSliderInput(rewardSlider, rewardVal);
        syncSliderInput(closedSlider, closedVal);

        function updateRewardDisplay() {
            document.getElementById('reward-display').textContent = '+' + rewardVal.value;
        }

        function updateTheoreticalValues() {
            const gamma = parseFloat(gammaVal.value);
            const reward = parseFloat(rewardVal.value);
            const closedProb = parseFloat(closedVal.value);
            const expectedReward = reward * (1 - closedProb);

            // Theoretical values: V(s) = Œ≥^(distance) * E[R]
            const theoretical = [
                expectedReward * Math.pow(gamma, 3), // Home: 3 steps away
                expectedReward * Math.pow(gamma, 2), // Park: 2 steps away
                expectedReward * Math.pow(gamma, 1), // Street: 1 step away
                expectedReward                        // Coffee: 0 steps
            ];

            for (let i = 0; i < 4; i++) {
                document.getElementById(`theory-${i}`).textContent = theoretical[i].toFixed(2);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Update value displays
        function updateValueDisplay() {
            const maxVal = parseFloat(rewardVal.value) * 1.2;
            
            for (let i = 0; i < 4; i++) {
                const bar = document.getElementById(`bar-${i}`);
                const valDisplay = document.getElementById(`val-${i}`);
                const height = Math.max(0, Math.min(100, (values[i] / maxVal) * 100));
                bar.style.height = `${height}%`;
                
                if (i < 3) {
                    valDisplay.textContent = values[i].toFixed(2);
                }
            }
        }

        // Move agent to position
        function moveAgentTo(position) {
            const percentages = [6, 31, 56, 81]; // Approximate center of each card
            agentContainer.style.left = `${percentages[position]}%`;
        }

        // Highlight location
        function highlightLocation(index, highlight) {
            const loc = document.getElementById(`loc-${index}`);
            if (highlight) {
                loc.classList.add('active');
            } else {
                loc.classList.remove('active');
            }
        }

        // Run a single walk episode
        async function runWalk(animate = true) {
            if (isAnimating) return;
            isAnimating = true;

            const alpha = parseFloat(alphaVal.value);
            const gamma = parseFloat(gammaVal.value);
            const reward = parseFloat(rewardVal.value);
            const closedProb = parseFloat(closedVal.value);

            // Determine if shop is open
            const shopOpen = Math.random() >= closedProb;
            const R = shopOpen ? reward : 0;

            let tdErrors = [];
            currentPosition = 0;
            moveAgentTo(0);

            if (animate) await sleep(200);

            // Walk through each state
            for (let s = 0; s < 3; s++) {
                if (animate) {
                    highlightLocation(s, true);
                    moveAgentTo(s);
                    agent.classList.add('walking');
                    await sleep(300);
                    agent.classList.remove('walking');
                }

                // Calculate TD error: Œ¥ = R + Œ≥V(s') - V(s)
                // R is only received at the last transition (s=2 -> s=3)
                const nextState = s + 1;
                const immediateReward = (s === 2) ? R : 0;
                const tdError = immediateReward + gamma * values[nextState] - values[s];
                tdErrors.push(tdError);

                // Update value
                values[s] += alpha * tdError;

                if (animate) {
                    highlightLocation(s, false);
                    updateValueDisplay();
                    
                    // Flash TD error
                    const loc = document.getElementById(`loc-${s}`);
                    if (tdError > 0.1) {
                        loc.classList.add('td-flash');
                        setTimeout(() => loc.classList.remove('td-flash'), 500);
                    } else if (tdError < -0.1) {
                        loc.classList.add('td-flash-negative');
                        setTimeout(() => loc.classList.remove('td-flash-negative'), 500);
                    }
                }
            }

            // Arrive at coffee shop
            if (animate) {
                moveAgentTo(3);
                highlightLocation(3, true);
                
                const coffeeIcon = document.getElementById('coffee-icon');
                if (shopOpen) {
                    coffeeIcon.classList.add('celebrate');
                    agent.textContent = 'üòä';
                    setTimeout(() => {
                        coffeeIcon.classList.remove('celebrate');
                        agent.textContent = 'üö∂';
                    }, 600);
                } else {
                    coffeeIcon.textContent = 'üö´';
                    agent.textContent = 'üò¢';
                    setTimeout(() => {
                        coffeeIcon.textContent = '‚òï';
                        agent.textContent = 'üö∂';
                    }, 600);
                }

                await sleep(600);
                highlightLocation(3, false);
            }

            // Update displays
            episodeCount++;
            episodeCountDisplay.textContent = episodeCount;
            updateValueDisplay();

            // Update summary
            document.getElementById('steps-taken').textContent = '3';
            document.getElementById('reward-received').textContent = shopOpen ? `+${reward}` : '0';
            document.getElementById('reward-received').className = shopOpen 
                ? 'text-xl font-bold text-emerald-600' 
                : 'text-xl font-bold text-red-500';

            const avgTD = tdErrors.reduce((a, b) => a + b, 0) / tdErrors.length;
            const tdDisplay = document.getElementById('avg-td-error');
            if (avgTD > 0.1) {
                tdDisplay.innerHTML = `<span class="text-emerald-500">+${avgTD.toFixed(2)}</span>`;
            } else if (avgTD < -0.1) {
                tdDisplay.innerHTML = `<span class="text-red-500">${avgTD.toFixed(2)}</span>`;
            } else {
                tdDisplay.innerHTML = `<span class="text-slate-400">${avgTD.toFixed(2)}</span>`;
            }

            document.getElementById('walk-status').textContent = shopOpen 
                ? '‚òï Got coffee!' 
                : 'üò¢ Shop was closed!';

            // Reset agent position
            if (animate) {
                await sleep(400);
                moveAgentTo(0);
            }

            isAnimating = false;
        }

        // Run multiple walks
        async function runMultipleWalks(n) {
            walkBtn.disabled = true;
            walk10Btn.disabled = true;
            
            for (let i = 0; i < n; i++) {
                await runWalk(false);
                await sleep(30);
            }
            
            walkBtn.disabled = false;
            walk10Btn.disabled = false;
        }

        // Reset
        function reset() {
            values = [0, 0, 0, 0];
            episodeCount = 0;
            currentPosition = 0;
            episodeCountDisplay.textContent = '0';
            updateValueDisplay();
            moveAgentTo(0);
            
            document.getElementById('steps-taken').textContent = '‚Äî';
            document.getElementById('reward-received').innerHTML = '‚Äî';
            document.getElementById('avg-td-error').innerHTML = '<span class="text-slate-300">‚Äî</span>';
            document.getElementById('walk-status').textContent = 'Ready to walk!';
        }

        // Event listeners
        walkBtn.addEventListener('click', () => runWalk(true));
        walk10Btn.addEventListener('click', () => runMultipleWalks(10));
        resetBtn.addEventListener('click', reset);

        // Initialize
        updateValueDisplay();
        updateTheoreticalValues();
        moveAgentTo(0);
    </script>
</body>
</html>
